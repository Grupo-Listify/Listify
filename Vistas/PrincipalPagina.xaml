<?xml version="1.0" encoding="utf-8" ?>
<ContentPage 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:local="clr-namespace:Listify.Modelos"
    xmlns:recursos="clr-namespace:Listify.Recursos"
    x:Class="Listify.Vistas.PrincipalPagina"
    x:Name="Pagina"
    Title="Lista de Compras">

    <!-- Converter existente -->
    <ContentPage.Resources>
        <ResourceDictionary>
            <recursos:BoolToTextDecorationConverter x:Key="BoolToTextDecorationConverter" />

            <!-- Paleta local (solo UI) -->
            <Color x:Key="CardBgLight">#FFFFFF</Color>
            <Color x:Key="CardBgDark">#1E1E1E</Color>
            <Color x:Key="CardBorderLight">#E6E6E6</Color>
            <Color x:Key="CardBorderDark">#2B2B2B</Color>

            <Color x:Key="PillBgLight">#EEF2FF</Color>
            <Color x:Key="PillBgDark">#2B2F3A</Color>
            <Color x:Key="PillTextLight">#304FFE</Color>
            <Color x:Key="PillTextDark">#9AB0FF</Color>

            <Color x:Key="EditBg">#4F46E5</Color>
            <Color x:Key="DeleteBg">#EF4444</Color>
        </ResourceDictionary>
    </ContentPage.Resources>

    <ContentPage.Content>
        <Grid Padding="12" RowDefinitions="Auto,*">

            <!-- Búsqueda -->
            <SearchBar Grid.Row="0"
                       Placeholder="Buscar..."
                       Margin="0,0,0,8"
                       Text="{Binding TextoBusqueda, Mode=TwoWay}"
                       TextChanged="SearchBar_TextChanged" />

            <!-- Lista -->
            <CollectionView Grid.Row="1"
                            ItemsSource="{Binding Articulos}"
                            SelectionMode="None"
                            ItemSizingStrategy="MeasureAllItems">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical"/>
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <!-- Cada item es un Articulo -->
                    <DataTemplate x:DataType="local:Articulo">

                        <!-- Acciones por swipe (se mantienen) -->
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItems Mode="Execute">
                                    <SwipeItem Text="Editar"
                                               BackgroundColor="LightBlue"
                                               Command="{Binding Source={x:Reference Pagina}, Path=BindingContext.EditarArticuloCommand}"
                                               CommandParameter="{Binding .}" />
                                    <SwipeItem Text="Eliminar"
                                               BackgroundColor="Tomato"
                                               Command="{Binding Source={x:Reference Pagina}, Path=BindingContext.EliminarArticuloCommand}"
                                               CommandParameter="{Binding .}" />
                                </SwipeItems>
                            </SwipeView.RightItems>

                            <!-- Tarjeta del item (solo UI) -->
                            <Grid>
                                <Frame Margin="0,6"
                                       Padding="12"
                                       HasShadow="True"
                                       CornerRadius="14"
                                       BackgroundColor="{AppThemeBinding Light={StaticResource CardBgLight}, Dark={StaticResource CardBgDark}}"
                                       BorderColor="{AppThemeBinding Light={StaticResource CardBorderLight}, Dark={StaticResource CardBorderDark}}">

                                    <!-- Fila: Check | Nombre (tachado) | Pill Cantidad | Editar | Eliminar -->
                                    <Grid ColumnDefinitions="Auto,*,Auto,Auto,Auto"
                                          ColumnSpacing="12">

                                        <!-- Comprado (misma lógica) -->
                                        <CheckBox IsChecked="{Binding Comprado, Mode=TwoWay}"
                                                  VerticalOptions="Center"
                                                  CheckedChanged="CheckBox_CheckedChanged" />

                                        <!-- Nombre + tachado via converter -->
                                        <Label Grid.Column="1"
                                               VerticalOptions="Center"
                                               FontAttributes="Bold"
                                               FontSize="16"
                                               TextDecorations="{Binding Comprado, Converter={StaticResource BoolToTextDecorationConverter}}">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="{Binding Nombre}" />
                                                    <Span Text=" (x" />
                                                    <Span Text="{Binding Cantidad}" />
                                                    <Span Text=")" />
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>

                                        <!-- Cantidad como "pill" -->
                                        <Frame Grid.Column="2"
                                               Padding="10,4"
                                               HasShadow="False"
                                               CornerRadius="12"
                                               BackgroundColor="{AppThemeBinding Light={StaticResource PillBgLight}, Dark={StaticResource PillBgDark}}"
                                               VerticalOptions="Center">
                                            <Label Text="{Binding Cantidad, StringFormat='x{0}'}"
                                                   TextColor="{AppThemeBinding Light={StaticResource PillTextLight}, Dark={StaticResource PillTextDark}}"
                                                   FontAttributes="Bold"
                                                   FontSize="12" />
                                        </Frame>

                                        <!-- EDITAR (mismos Commands) -->
                                        <Button Grid.Column="3"
                                                Text="Editar"
                                                Padding="14,8"
                                                CornerRadius="10"
                                                BackgroundColor="{StaticResource EditBg}"
                                                TextColor="White"
                                                VerticalOptions="Center"
                                                Command="{Binding Source={x:Reference Pagina}, Path=BindingContext.EditarArticuloCommand}"
                                                CommandParameter="{Binding .}" />

                                        <!-- ELIMINAR (mismos Commands) -->
                                        <Button Grid.Column="4"
                                                Text="Eliminar"
                                                Padding="14,8"
                                                CornerRadius="10"
                                                BackgroundColor="{StaticResource DeleteBg}"
                                                TextColor="White"
                                                VerticalOptions="Center"
                                                Command="{Binding Source={x:Reference Pagina}, Path=BindingContext.EliminarArticuloCommand}"
                                                CommandParameter="{Binding .}" />
                                    </Grid>

                                    <!-- Si está Comprado, bajamos opacidad (UI) -->
                                    <Frame.Triggers>
                                        <DataTrigger TargetType="Frame"
                                                     Binding="{Binding Comprado}"
                                                     Value="True">
                                            <Setter Property="Opacity" Value="0.65" />
                                        </DataTrigger>
                                    </Frame.Triggers>
                                </Frame>
                            </Grid>
                        </SwipeView>

                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Botón flotante Agregar (sin cambios de lógica) -->
            <Grid Grid.RowSpan="2"
                  HorizontalOptions="End"
                  VerticalOptions="End">
                <Button Text="+"
                        FontSize="26"
                        WidthRequest="60"
                        HeightRequest="60"
                        CornerRadius="30"
                        BackgroundColor="DodgerBlue"
                        TextColor="White"
                        Command="{Binding AgregarArticuloCommand}" />
            </Grid>
        </Grid>
    </ContentPage.Content>
</ContentPage>
